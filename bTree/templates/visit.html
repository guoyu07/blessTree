<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <!--<meta name="viewport" content="width=device-width, initial-scale=1.0,user-scalable=no">-->
    <meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=0.5, maximum-scale=2.0, user-scalable=no" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="format-detection" content="telephone=no" />
    <title>{{ owner }}的空间</title>

    <!--CSS-->
    {% load staticfiles %}
    <link rel="stylesheet" type="text/css" href="{% static "tree/css/visit.css" %}">

    <link rel="stylesheet" type="text/css" href="{% static "plugin/weui/weui.min.css" %}">
    <link href="//cdn.bootcss.com/pure/0.6.0/pure-min.css" rel="stylesheet">
    <link rel="stylesheet" href="http://yui.yahooapis.com/pure/0.5.0/grids-responsive-min.css">

    <!--js-->
    <script src="{% static "plugin/jquery/jquery.min.js" %}"></script>
    <script src="{% static "plugin/jquery/jquery.color.js" %}"></script>
    <script src="{% static "plugin/jquery/jquery.mobile-events.min.js" %}"></script>
    <script src="{% static "tree/js/jquery.lqc.extension.js" %}"></script>
    <script src="{% static "tree/js/visit.js" %}"></script>


</head>
<body class="my-body">
{% if error %}
    <p>我知道这是你最讨厌的页面404～～，赶紧邀请他参加吧～～</p>
{% else %}
<!--顶部-->
<div class="menu-top">
    <div class="menu-top-con">
        <!--头像-->
        <div class="self-avatar">
            <a><img class="avatar" src="{{ avatar }}" style="width: inherit"></a>
        </div>
        <!--积分条-->
        <div class="count-progress">
            <div class="progress">
                <span class="progress-bar" id="progress-bar"><span class="progress-in" id="progress-in"></span></span>
            </div>
            <div class="count-num" id="count-num"><p>积分:{{ count }}</p></div>
        </div>
        <!--历史-->
        <div class="history" id="history" style="width: 11%;padding-left: 4%;">
            <a id="history"><img class="history-btn" src="{% static "tree/image/btn/history.png" %}"></a>
        </div>
        <!--我的主页-->
        <div class="zone" id="zone" style="width: 11%; padding-left: 5%">
            <a ><img class="zone-btn" id="zone-btn" src="{% static "tree/image/btn/zone.png" %}" ></a>
        </div>
    </div>
</div>

<!--内容-->
<div class="main-container">
    <!--上面两个菜单-->
    <div class="main-top">
        <div class="water-flower">
            <a id="water-flower"><img class="water-btn" src="{% static "tree/image/btn/water.png" %}" style="width: inherit"></a>
        </div>
        <div class="willing">
            <a id="willing"><img class="willing-btn" src="{% static "tree/image/btn/willing.png" %}" style="width: inherit"></a>
        </div>
    </div>
    <div class="main-area">
        <!--树木区域-->
        <div class="main-tree pure-u-19-24" style="float: left;">
            <div class="tree-area" style="height: 80%;padding-top: 6%;padding-left: 13%">
                <img src="{% static "tree/image/others/tree.png" %}">
                <div class="bless1" style="background-color: red;z-index:13;height: 4%;width: 6%;position: absolute;left: 54%;top: 16%;border-radius: 50%"></div>
                <div class="bless1" id="bless3" style="background-color: red;z-index:13;height: 4%;width: 6%;position: absolute;left: 45%;top: 22%;border-radius: 50%"></div>
                <div class="bless2" style="background-color: white;height: 4%;width: 6%;position: absolute;left: 62%;top: 22%;border-radius: 50%"></div>

                <div class="bless2" style="background-color: white;height: 4%;width: 6%;position: absolute;left: 54%;top: 29%;border-radius: 50%"></div>
                <div class="bless1" style="background-color: red;height: 4%;width: 6%;position: absolute;left: 43%;top: 35%;border-radius: 50%"></div>
                <div class="bless2" style="background-color: white;height: 4%;width: 6%;position: absolute;left: 68%;top: 35%;border-radius: 50%"></div>

                <div class="bless2" style="background-color: white;height: 4%;width: 6%;position: absolute;left: 46%;top: 49%;border-radius: 50%"></div>
                <div class="bless1" style="background-color: red;height: 4%;width: 6%;position: absolute;left: 60%;top: 45%;border-radius: 50%"></div>
                <div class="bless1" style="background-color: red;height: 4%;width: 6%;position: absolute;left: 36%;top: 55%;border-radius: 50%"></div>
                <div class="bless2" style="background-color: white;height: 4%;width: 6%;position: absolute;left: 70%;top: 51%;border-radius: 50%"></div>

                <div class="bless2" style="background-color: white;height: 4%;width: 6%;position: absolute;left: 54%;top: 65%;border-radius: 50%"></div>
                <div class="bless1" style="background-color: red;height: 4%;width: 6%;position: absolute;left: 26%;top: 67%;border-radius: 50%"></div>
                <div class="bless1" style="background-color: red;height: 4%;width: 6%;position: absolute;left: 40%;top: 71%;border-radius: 50%"></div>
                <div class="bless1" style="background-color: red;height: 4%;width: 6%;position: absolute;left: 66%;top: 70%;border-radius: 50%"></div>
                <div class="bless2" style="background-color: white;height: 4%;width: 6%;position: absolute;left: 78%;top: 70%;border-radius: 50%"></div>
            </div>
            <div class="tree-name">
                <img src="{% static "tree/image/others/name.png" %}">
                <p class="name" style="margin-top: 19%;margin-left: 23%;font-size: 50%">{{ tree_name }}</p>
            </div>
        </div>
        <div class="main-right pure-u-5-24" style="float:left">
            <ul class="right-btn" style="list-style-type: none;height: 70%;">
                <!--吐槽-->
                <li id="tucao-btn"><img class="tucao" src="{% static "tree/image/btn/tucao.png" %}" style="width: 74%"></li>
                <!--祝福-->
                <li id="bless-btn"><img class="bless" src="{% static "tree/image/btn/bless.png" %}" style="width: 74%"></li>
            </ul>
        </div>
    </div>
</div>

<!--脚本-->
<div class="footer"></div>

<!--begin 小部件-->
<!--mask-->
<!--祝福与吐槽-->
<div class="tucao-widget" id="tucao-widget" style="display: none">
    <div class="tucao-widget-top">
        <img src="{% static "tree/image/btn/tucao.png" %}">
        <p>吐槽</p>
{#        <a class="tucao-close" id="tucao-close">X</a>#}
    </div>
    <div class="tucao-form-con">
        <div class="tucao-form">
            <textarea id="tucao-area" style="font-size: small" placeholder="我知道你想骂我很久了，没关系，让暴风雨来得更猛烈些吧"></textarea>
            <label style="display: block;"><input id="tucao-na" name="na" type="checkbox" value="" />匿名 </label>
            <a id="rand_tucao_1" style="font-size: 80%"></a><a id="rand_tucao_2" style="font-size: 80%"></a>
            <button class="tucao-confirm" id="tucao_confirm">确定</button>
        </div>
    </div>
</div>

<div class="bless-widget" id="bless-widget" style="display: none;">
    <div class="bless-widget-top">
        <img src="{% static "tree/image/btn/bless.png" %}">
        <p>祝福</p>
{#        <a class="bless-close" id="bless-close">X</a>#}
    </div>
    <div class="bless-form-con">
        <div class="bless-form">
            <textarea id="bless-area" style="font-size: small" placeholder="我知道你很欣赏我，我也很欣赏你的诚实"></textarea>
            <label style="display: block"><input id="bless-na" name="na" type="checkbox" value="" />匿名 </label>
            <a id='rand_bless_1' style="font-size: 80%"></a><a id="rand_bless_2" style="font-size: 80%"></a>
            <button id="bless_confirm" class="bless-confirm">确定</button>
        </div>
    </div>
</div>
    <!--浇水图片样例-->
<div class="water-widget" id="water-widget" style="display: none;width: 30%;position: fixed;
    z-index: 13;
    width: 25%;
    left: 50%;
    height: auto;
    top: 50%;">
    <img src="{% static "tree/image/others/water-tree.png" %}" style="width: 100%;height: auto">
</div>
<!--浇水提醒-->
<div class="water-tips" id="water-tips" style="display: none;">
    <p>点击<img src="{% static "tree/image/btn/water.png" %}">&nbsp&nbsp给小树苗浇水，可以帮助它长成大树哦</p>
    <button class="water-tips-btn">去浇水<img src="{% static "tree/image/btn/goto.png" %}"></button>
</div>
<!--浇水成功-->
<div class="water-success" id="water-success" style="display: none;">
    <p>浇水成功，不愧是我的真爱粉～~\(≧▽≦)/~</p>
    <button>我知道啦</button>
</div>
<div class="overlay" id="black-mask" style="display: none;position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0,0,0,.3);"></div>
<!--心愿-->
<div class="willing-widget" id="willing-widget" style="display: none">
    <div class="willing-top">
        <img src="{% static "tree/image/btn/willing.png" %}">
        <p style="font-size: 80%">心愿</p>
    </div>
    <hr style="background-color: rgba(0,0,0,0.6)">
    <div class="willing-content">
        <ul class="willing-list" id="willing-list">
            <li id="willing-list-na" style="display: none;text-align: center">
                <p style="text-align: center;font-size: 100%;">{{ owner }}还没有填写新年愿望～</p>
            </li>
            <li id="willing-list-li" style="display: none;">
                <a id="will-time" style="float: left;width: 20%;font-size: 80%; text-align: left;font-size: 60%">时间</a>
                <a id="will-con" style="float:left;margin-left: 20%;text-align: left">内容</a>
            </li>
        </ul>
    </div>
</div>

<!--祝福吐槽的历史-->
<div class="history-widget popupLayer" id="history-widget" style="display: none">
    <div class="history-top">
        <a class="history-bless" id="history-bless">祝福</a>
        <a class="history-tucao" id="history-tucao">吐槽</a>
    </div>
    <hr style="background-color: rgba(0,0,0,0.6)">
    <div class="history-content">
        <ul class="history-list" id="history-bless-list">
            <li id="history-bless-list-na">
               <p>没有收到小伙伴的祝福哦</p>
            </li>
            <li id="history-bless-list-li" style="display: none;overflow: auto;">
                <div style="float:left;"class="pure-u-5-24">
                    <img id="history-bless-avatar" src="{% static "tree/image/btn/friends.png" %}" style="height: 75%;padding-left: 5%;border-radius: 50%">
                    <p id="history-bless-name" style="font-size: 40%;color:grey;;">名字</p>
                </div>
                <div style="float: left" class="pure-u-15-24">
                    <a id="history-bless-con" style="font-size: 70%;">吐槽内容</a>
                </div>
                <div style="float: left" class="pure-u-4-24">
                    <a id="history-bless-time" style="float: right;font-size: 60%;color: grey">什么时间前</a>
                </div>
            </li>

        </ul>
        <ul class="history-list" id="history-tucao-list" style="display: none;">
            <li id="history-tucao-list-na">
               <p>没有收到小伙伴的吐槽哦～</p>
            </li>
            <li id="history-tucao-list-li" style="display: none;overflow: auto">
                <div style="float:left;"class="pure-u-5-24">
                    <img id="history-tucao-avatar" src="{% static "tree/image/btn/friends.png" %}" style="height: 75%;padding-left: 5%;border-radius: 50%">
                    <p id="history-tucao-name" style="font-size: 40%;color:grey;;">名字</p>
                </div>
                <div style="float: left" class="pure-u-15-24">
                    <a id="history-tucao-con" style="font-size: 70%;">内容</a>
                </div>
                <div style="float: left" class="pure-u-4-24">
                    <a id="history-tucao-time" style="float: right;font-size: 60%;color: grey">几天前</a>
                </div>
            </li>

        </ul>
    </div>
</div>

<!--浇水特效-->
<div class="water-widget" id="water-widget" style="display: none;width: 30%;position: fixed;
    z-index: 13;
    width: 25%;
    left: 50%;
    height: auto;
    top: 50%;">
    <img src="{% static "tree/image/others/water-tree.png" %}" style="width: 100%;height: auto">
</div>

<!--恭喜新年快乐-->
<div class="happy-newyear" id="happy-newyear" style="display: none">
    <img src="{% static "tree/image/others/monkey.png" %}">
    <p style="font-size: 160%;margin-top: 0%;color: red">给大家拜年啦</p>
</div>

{% endif %}
</body>
<script>
    {% if error %}
    $(function () {
        alert("调皮～该用户尚未种树，不能访问哟～～")
    })
    {% else %}
    $(function () {
        //一些需要判断逻辑的全局变量
        var water_time = {{ water_time }}  //最近一次浇水时间
        var after_width = {{ count }}/300000*100;
        water_time = 0
        //新年快乐
        if(parseInt($("#count-num").text().substr(3))>=300000){
            // 积分够了，显示新年快乐
            $("#happy-newyear").fadeIn(1000)
                    .on('tap', function () {
                        $("#happy-newyear").fadeOut(1000)
                    })
        }
        $("#progress-in").css("width", "{{ count_bar }}%");
{##}
        //我的主页
        $("#zone").on('tap', function () {
            window.open("{{ my_zone_url|safe }}")
        })
{#        //发送ajax#}
        $('#tucao_confirm').on('tap', function () {
            var tucao_con = $('#tucao-area').val();
            if(tucao_con==''){
                alert('亲还什么都没写呢～')
            }else {
                var na = $("#tucao-na").is(':checked') //是否匿名
                if (na == true) {
                    var source_id = "na"
                } else {
                    var source_id = "{{ flip_id }}"  //这个是发送消息的id，也就是谁祝福的
                }
                var openid = "{{ sourceid }}"  //这个sourceid是谁的主页的id
                $.ajax({
                    url: 'http://1.blesstree.sinaapp.com/wechat/ajax',
                    type: 'POST',
                    timeout: 1000,
                    dataType: 'json',
                    async: false,  //不能异步去传输，否则有些数据就没有了
                    encoding: 'utf-8',
                    data: {
                        'ajax_type': '10',
                        'openid': openid,
                        'source_id': source_id,
                        'tucao_con': tucao_con
                    },
                    error: function () {
                        alert('您的网络似乎不稳定，请重新尝试一下哦～')
                    },  //错误执行方法
                    success: function (ret) {
                        if (ret == '1') {
                            alert('您的吐槽已对敌方造成8000点伤害～')
                        } else if (ret == '2') {
                            alert('不能提交空白吐槽哟～')
                        } else {
                            alert('似乎遇到了小菌也未曾遇到的问题呢～')
                        }
                        $("#black-mask").hide()
                        $("#tucao-widget").hide();
                        // 积分与进度条变化
                        var val = parseInt($("#count-num").text().substr(3))
                        $("#count-num").text('积分:'+(val-8000).toString())
                        var css_width = parseInt($("#progress-bar").css("width"));
                        after_width = after_width + (parseInt($("#progress-in").css("width"))-css_width*0.027)
                        if(after_width<0){css_width=0}
                        else{css_width=(parseInt($("#progress-in").css("width"))-css_width*0.027)}
                        $("#progress-in").css("width", css_width.toString())
                    }
                })
            }

        })
        $('#bless_confirm').on('tap', function () {
            var bless_con = $('#bless-area').val();
            if(bless_con==''){
                alert('亲还什么都没写呢～')
            }else{
                var na = $("#bless-na").is(':checked') //是否匿名
                if(na==true){
                    var source_id = "na"
                }else{
                    var source_id = "{{ flip_id }}"  //这个是发送消息的id，也就是谁祝福的
                }
                var openid = "{{ sourceid }}"  //这个sourceid是谁的主页的id
                $.ajax({
                    url: 'http://1.blesstree.sinaapp.com/wechat/ajax',
                    type: 'POST',
                    timeout: 1000,
                    dataType: 'json',
                    async:false,  //不能异步去传输，否则有些数据就没有了
                    encoding:'utf-8',
                    data:{
                        'ajax_type' : '9',
                        'openid' : openid,
                        'source_id': source_id,
                        'bless_con' : bless_con
                    },
                    error: function () {
                        alert('您的网络似乎不稳定，请重新尝试一下哦～')
                    },  //错误执行方法
                    success: function (ret) {
                        if(ret == '1'){
                            alert('您的祝福对方已经收到啦～')
                        }else if(ret == '2'){
                            alert('不能提交空白祝福哦～')
                        }else{
                            alert('似乎遇到了小菌也未曾遇到的问题呢～')
                        }
                        $("#black-mask").hide()
                        $("#bless-widget").hide();
                        // 积分与进度条变化
                        var val = parseInt($("#count-num").text().substr(3))
                        $("#count-num").text('积分:'+(val+5000).toString())
                        var css_width = parseInt($("#progress-bar").css("width"));
                        after_width = after_width +(parseInt($("#progress-in").css("width"))+css_width*0.017)
                        if(after_width <0 ){
                            css_width = 0;
                        }else{css_width = after_width}
                        $("#progress-in").css("width", (parseInt($("#progress-in").css("width"))+css_width*0.017).toString())
                    }
                })
            }


        })


        /****************
     * 按钮逻辑
     * */
    //历史按钮
    $("#history").on('tap', function () {
        // 祝福加载好，吐槽之后加载
        if($("#history-bless-list li:last").css('display')=='none'){
            $.ajax({
                url: 'http://1.blesstree.sinaapp.com/wechat/ajax',
                type: 'POST',
                timeout: 1000,
                dataType: 'json',
                async: false,
                encoding:'utf-8',
                data:{
                    'ajax_type' : '5',  //祝福类型
                    'openid' : '{{ sourceid }}',
                    'load_begin' : '0'
                },
                beforeSend: function () {
                }, //加载执行方法
                error: function () {
                    alert('数据请求异常')
                },  //错误执行方法
                success: function (ret) {
                    //决定显示的内容
                    if(ret=='1'){
                            $("#history-bless-list-na").show();
                        }else{
                            $("#history-bless-list-na").hide();
                            $.each(ret, function (i, item) {
                                $('#history-bless-avatar').attr('src', item.bless_avatar)
                                $('#history-bless-name').text(item.bless_nick)
                                $("#history-bless-con").text(item.bless_con)
                                $('#history-bless-time').text(item.bless_time)
                                var bless_list = $("#history-bless-list-li").clone().show()
                                $('#history-bless-list').append(bless_list)
                            })
                        }
                    //控制显示
                    $('#black-mask').show()
                            .on('tap', function () {
                                $("#history-widget").hide();
                                $("#black-mask").hide();
                            })
                    $("#history-widget").show();
                    $("#history-tucao-list").hide();
                    $("#history-bless-list").show();
                    disableScroll()
                }
            })
        }else{
            //控制显示
            $('#black-mask').show()
                    .on('tap', function () {
                        $("#history-widget").hide();
                        $("#black-mask").hide();
                    })
            $("#history-widget").show();
            $("#history-tucao-list").hide();
            $("#history-bless-list").show(300);
            disableScroll()
        }

    })
    //祝福吐槽切换
    $("#history-bless").on('tap', function () {
        $("#history-tucao-list").hide();
        $("#history-bless-list").show(300);
    });
    $("#history-tucao").on('tap', function () {
        $("#history-bless-list").hide();
        if($("#history-tucao-list li:last").css('display')=='none'){
            $.ajax({
                url: 'http://1.blesstree.sinaapp.com/wechat/ajax',
                type: 'POST',
                timeout: 1000,
                dataType: 'json',
                async: false,
                encoding:'utf-8',
                data:{
                    'ajax_type' : '6',  //吐槽类型
                    'openid' : '{{ sourceid }}',
                    'load_begin' : '0'
                },
                beforeSend: function () {
                }, //加载执行方法
                error: function () {
                    alert('数据请求异常')
                },  //错误执行方法
                success: function (ret) {
                    //决定显示的内容
                    if (ret == '1') {
                        $("#history-tucao-list-na").show()
                    } else {
                        $.each(ret, function (i, item) {
                            $("#history-tucao-list-na").hide()
                            $('#history-tucao-avatar').attr('src', item.tucao_avatar)
                            $('#history-tucao-name').text(item.tucao_nick)
                            $("#history-tucao-con").text(item.tucao_con)
                            $('#history-tucao-time').text(item.tucao_time)
                            var tucao_list = $("#history-tucao-list-li").clone().show()
                            $('#history-tucao-list').append(tucao_list)
                        })
                    }
                    //控制显示
                    $('#black-mask').show()
                            .on('tap', function () {
                                $("#history-widget").hide();
                                $("#black-mask").hide();
                            })
                    $("#history-widget").show();
                    $("#history-bless-list").hide();
                    $("#history-tucao-list").show(300);
                }
            })
        }else{
            $("#history-bless-list").hide();
            $("#history-tucao-list").show(300);
        }
    })
    //心愿
    $('#willing').on('tap', function () {
        if($('#willing-list li:last').css('display') == 'none'){
            $.ajax({
                url: 'http://1.blesstree.sinaapp.com/wechat/ajax',
                type: 'POST',
                timeout: 1000,
                dataType: 'json',
                async: false,
                encoding:'utf-8',
                data:{
                    'ajax_type' : '7',
                    'openid' : '{{ sourceid }}',
                    'load_begin' : '0'
                },
                beforeSend: function () {
                }, //加载执行方法
                error: function () {
                    alert('数据请求异常')
                },  //错误执行方法
                success: function (ret) {
                    if(ret=='1'){
                        $("#willing-list-na").show()
                    }else{
                        $.each(ret, function (i, item) {
                            $('#will-time').text(item.will_time)
                            $('#will-con').text(item.will_con)
                            var will_list = $("#willing-list-li").clone().show()
                            $('#willing-list').append(will_list)
                        })
                    }
                    $("#black-mask").show();
                    $("#willing-widget").show();
                    $("#black-mask").on('tap', function () {
                        $("#willing-widget").hide();
                        $("#black-mask").hide();
                    })
                }
            })
        }else{
            $('#black-mask').show()
            $('#willing-widget').show()
            $('#black-mask').on('tap', function () {
                $('#willing-widget').hide();
                $('#black-mask').hide();
            })
        }
    })

    //浇水按钮
    $("#water-flower").on('tap', function () {
        {% if flip_nickname %}
        if(new Date().getTime()-water_time>10*60*1000){
            water_time = new Date().getTime();
            $("#water-widget").show();
            $('#water-widget').hide(3000);
            $.ajax({
            url: 'http://1.blesstree.sinaapp.com/wechat/ajax',
                type: 'POST',
                timeout: 1000,
                dataType: 'json',
                encoding:'utf-8',
                data:{
                    'ajax_type' : '4',
                    'openid' : '{{ sourceid }}',
                    'source_id' : '{{ flip_id }}'
                },
                beforeSend: function () {
                }, //加载执行方法
                error: function () {
                    water_time = 0;
                    alert('数据请求异常')
                },  //错误执行方法
                success: function (ret) {
                    if(ret=='1'){
                        alert('浇水成功，积分已奉上哟～')
                        // 积分与进度条变化
                        var val = parseInt($("#count-num").text().substr(3))
                        $("#count-num").text('积分:'+(val+1000).toString())
                        var css_width = parseInt($("#progress-bar").css("width"));
                        $("#progress-in").css("width", (parseInt($("#progress-in").css("width"))+css_width*0.003).toString())
                    }
                }
            })
        }else{
            alert('不能频繁的浇水哦～')
        }

        {% else %}
            window.open("{{ btn_redirect_url | safe}}")
        {% endif %}
    })

    //吐槽
    $("#tucao-btn").on('tap', function () {
        {% if flip_nickname %}
        $("#black-mask").show()
                .on('tap', function () {
                    $("#tucao-widget").hide()
                    $("#black-mask").hide()
                })
        $("#tucao-widget").show()
        {% else %}
            window.open("{{ btn_redirect_url | safe}}")
        {% endif %}
    })


    $("#rand_tucao_1").on('tap', function () {
        $("#tucao-area").val($('#rand_tucao_1').text())
    })
    $('#rand_tucao_2').on('tap', function () {
        $("#tucao-area").val($('#rand_tucao_2').text())
    })
    //祝福
    $("#bless-btn").on('tap', function () {
        {% if flip_nickname %}
        $("#black-mask").show()
                .on('tap', function () {
                    $("#bless-widget").hide()
                    $("#black-mask").hide()
                })
        $("#bless-widget").show();
        {% else %}
            window.open("{{ btn_redirect_url | safe}}")
        {% endif %}
    })

    //$("#bless-close").on('tap', function () {
    //    $("#bless-widget").hide();
    //})

    $("#rand_bless_1").on('tap', function () {
        $("#bless-area").val($('#rand_bless_1').text())
    })
    $('#rand_bless_2').on('tap', function () {
        $("#bless-area").val($('#rand_bless_2').text())
    })

    })
    //***************这里是下拉bug的修复*********************//
    function preventDefault(e) {
        e = e || window.event;
        e.preventDefault && e.preventDefault();
        e.returnValue = false;
    }
    function stopPropagation(e){
        e = e || window.event;
        e.stopPropagation && e.stopPropagation();
        e.cancelBubble = false;
    }
    function innerScroll(e){
        // 阻止冒泡到document
        stopPropagation(e);
        var delta = e.wheelDelta || e.detail || 0;
        var box = $(this).get(0);
        if($(box).height() + box.scrollTop >= box.scrollHeight){
            if(delta < 0) {
                preventDefault(e);
                return false;
            }
        }
        if(box.scrollTop === 0){
            if(delta > 0) {
                preventDefault(e);
                return false;
            }
        }
    }
    var disableScroll = function(){
        $(document).on('mousewheel', preventDefault);
        $(document).on('touchmove', preventDefault);
    };
    var enableScroll = function(){
        $(document).off('mousewheel', preventDefault);
        $(document).off('touchmove', preventDefault);
    };

    // 内部可滚
    $('.popupLayer').on('mousewheel', innerScroll);
    // 外部禁用
    disableScroll()



    // 移动端touch重写
    var startX, startY;
    $('.popupLayer').on('touchstart', function(e){
        startX = e.changedTouches[0].pageX;
        startY = e.changedTouches[0].pageY;
    });

    // 仿innerScroll方法
    $('.popupLayer').on('touchmove', function(e){
        e.stopPropagation();

        var deltaX = e.changedTouches[0].pageX - startX;
        var deltaY = e.changedTouches[0].pageY - startY;

        // 只能纵向滚
        if(Math.abs(deltaY) < Math.abs(deltaX)){
            e.preventDefault();
            return false;
        }

        var box = $(this).get(0);

        if($(box).height() + box.scrollTop >= box.scrollHeight){
            if(deltaY < 0) {
                e.preventDefault();
                return false;
            }
        }
        if(box.scrollTop === 0){
            if(deltaY > 0) {
                e.preventDefault();
                return false;
            }
        }
    });

    {% endif %}
</script>
</html>